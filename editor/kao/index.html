<meta charset=utf-8>
<title>Koei 頭像檢視器</title>
<table>
	<tr><td  colspan=2> 頭像 <input id=upload onchange="file='';loading.innerHTML='資料讀取中...';upload(event)" type=file></td></tr>
	<tr><td valign=top><p id=loading></p>
	<br> 群組 <input id=group  onchange=upload(event) type=number  value=16 max=9999 min=1>
	<br> 移除 <input id=skip01 onchange=upload(event) type=number  value=0  max=9999 min=-999>
	<br> 擷取 <input id=skip02 onchange=upload(event) type=number  value=0  max=9999 min=-999>
	<br> 寬度 <input id=width  onchange=upload(event) type=number  value=64 max=9999 min=1>
	<br> 高度 <input id=height onchange=upload(event) type=number  value=80 max=9999 min=1>
	<br> 延展 <input id=extend onchange=upload(event) type=number  value=1  max=9999 min=1>
	<br> 色階 <input id=color0 onchange=upload(event) type=number  value=3  max=9999 min=1>
	<br> 色１ <input id=color1 onchange=upload(event) type=color   value=#000000>
	<br> 色２ <input id=color2 onchange=upload(event) type=color   value=#55FF55>
	<br> 色３ <input id=color3 onchange=upload(event) type=color   value=#FF5555>
	<br> 色４ <input id=color4 onchange=upload(event) type=color   value=#FFFF55>
	<br> 色５ <input id=color5 onchange=upload(event) type=color   value=#5555FF>
	<br> 色６ <input id=color6 onchange=upload(event) type=color   value=#55FFFF>
	<br> 色７ <input id=color7 onchange=upload(event) type=color   value=#FF55FF>
	<br> 色８ <input id=color8 onchange=upload(event) type=color   value=#FFFFFF>
	<br></td><td valign=top rowspan=12><canvas id=canvas hidden></canvas><img id=img></td>
	</tr>
</table>
<script>
file='';
query={};
location.href.split('?')[1]?.split('&').forEach((v, i) => { [key, value] = v.split(/=(.*)/g); query[key.toLowerCase()] = value; });
$    =(x)=>document.getElementById(x);
reset=(x,y)=>{ try {$(x).value=!!query[x]?query[x]:y;} catch {$(x).value=y;} }
reset('group' ,16);
reset('width' ,64);
reset('height',80);
reset('extend', 1);
reset('skip01', 0);
reset('skip02', 0);
reset('color0', 3);
reset('color1','#000000');
reset('color2','#55FF55');
reset('color3','#FF5555');
reset('color4','#FFFF55');
reset('color5','#5555FF');
reset('color6','#55FFFF');
reset('color7','#FF55FF');
reset('color8','#FFFFFF');
hex2dec=(x)=>    x.slice(1).replace(/.{2}/g,'$&,').split(',').slice(0,3).map(x=>parseInt(x,16));
dec2hex=(x)=>'#'+x.map(x=>x.toString(16)).join('');
upload=(event)=>{
	if(!file) file = event.target.files[0];
	if(	event.target && !!file){
		loading.innerHTML = '資料解析中...';
		reader = new FileReader();
		reader.readAsArrayBuffer(file);
		reader.onload = (event) => {
			loading.innerHTML = '確認畫布的大小...';
			kaodata      = width.value * height.value*3/8/extend.value;
			canvas.width = Math.ceil( width.value * group .value);
			result=event.target.result;
			result=result.slice(1+kaodata * skip01.value-1);
			result=result.slice(0,kaodata * skip02.value-1);
			canvas_height = Math.ceil(result.byteLength / kaodata);
			canvas.height = Math.ceil(canvas_height / group.value)*(height.value);
			loading.innerHTML = '頭像上色中...';
			ctx = canvas.getContext("2d");
			for(let i = 0; i < canvas_height; i++)ctx.putImageData(dataToImage(new Uint8Array(result).slice(kaodata * i, kaodata * i + kaodata)),
				Math.floor(i % group .value) * width .value,
				Math.floor(i / group .value) * height.value);
			loading .innerHTML = '';
			img.src = canvas.toDataURL();
		};
	}
};
dataToImage=(data)=>{
	imageData = new ImageData(width.value, height.value);
	p_index = getColorIndex(data);
	for(let i = 0; i < p_index.length; i++) {
		x = i % width .value;
		y = Math.floor(i / width .value);
		palette = [];
		palette.push(hex2dec(color1.value));
		palette.push(hex2dec(color2.value));
		palette.push(hex2dec(color3.value));
		palette.push(hex2dec(color4.value));
		palette.push(hex2dec(color5.value));
		palette.push(hex2dec(color6.value));
		palette.push(hex2dec(color7.value));
		palette.push(hex2dec(color8.value));
		c = palette[p_index[i]];
		idx = 4 * ((extend.value * y - 1) * width.value + x);
		for(let j in [0,0]){
			idx+= 4 * width .value;
			imageData.data[idx + 0] = c[0]; // red
			imageData.data[idx + 1] = c[1]; // green
			imageData.data[idx + 2] = c[2]; // blue
			imageData.data[idx + 3] =  255; // alpha
		}
	}
	return	imageData;
};
getColorIndex=(data)=>{ let z = []; grouper(data,color0.value*1).forEach(x=>{
	Array(             8).fill(0).map((_,x)=>x).map(i=>{n =0;
	Array(color0.value*1).fill(0).map((_,x)=>x).map(j=>{n|=(((x[j]>>(8-1-i))&1)<<(color0.value*1-1-j));
	}); z.push(n);
	});
	}); return z;
};
grouper=(arr, size, fillValue = null)=>{
	groups = [];
	for(let i = 0; i < arr.length; i += size)
		groups.push(arr.slice(i, i + size));
	if (fillValue !== null && groups.length * size < arr.length)
		groups.push([...arr.slice(groups.length * size), ...[size - (arr.length % size)].fill(fillValue)]);
	return groups;
};
openTab=()=>{
	x = window.open();
	x.document.open();
	x.document.write("<body style='margin:0'><iframe src='" + canvas.toDataURL() + "' width=100% height=100% frameborder=0></iframe>");
	x.document.close();
}
</script>
