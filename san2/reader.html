<!--

		啊...
		
		被我猜中你在偷看原始碼...
		
		好色喔...
		
		>///<
























































-->
<center	id="drop_zone"
		ondrop    ="drop_____handler(event)"
		ondragover="dragover_handler(event)"
		ondragend ="dragend__handler(event)">
	<title>	KOEI 三國志 2 DOS 版 存檔修改器 (BETA)	</title>
	<h1>	KOEI 三國志 2 DOS 版 存檔修改器 (BETA)	</h1>
	<p> 選擇 or 拖曳存檔，進行檢視 or 修改，最後下載輸出，覆蓋舊有檔案，即可完成修改。 </p>
	<form	name=frmConvert action="">
	<p>
	<input	type=file	id=fileinput	style="padding-left: 184px"	onchange="openFile(event)"/>
	</p><p>
	<input	type=button onclick="copy('hex')" value="複製１６進位資料">
	<input	type=text	name=dec	id=dec						value="">
	<input	type=button onclick="copy('dec')" value="複製１０進位資料">
	</p><p>
	<textarea			name=hex	id=hex	rows=10	cols=80		style="resize:none; overflow-x:hidden;"></textarea>
	</p><p>
	遊戲年份	<input	type=number	id=G_Y	min=0	max=65535	value=""	onchange="b02_onchange(this.id, 12, 1)">
	遊戲月份	<input	type=number	id=G_M	min=1	max=12		value=""	onchange="b01_onchange(this.id, 14, 1)">
	</p><p>
	人物姓名	<input	type=text	id=Nam	min=0				value=""	onchange="">
	</p><p>
	人物編號	<input	type=number	id=oid	min=0	max=65535	value=""	onchange="oid_onchange()" min=0>
	人物主管	<input	type=number	id=Rnk	min=0	max=65535	value=""	onchange="b01_onchange(this.id,- 8, 0)">
	人物頭像	<input	type=number	id=Pic	min=0	max=65535	value=""	onchange="">
	人物埋伏	<input	type=number	id=Amb	min=0	max=255		value=""	onchange="b01_onchange(this.id,-11, 0)">
	人物姻親	<input	type=number	id=Law	min=0	max=15		value=""	onchange="">
	</p><p>
	武裝比例	<input	type=number	id=Arm	min=0	max=255		value=""	readonly   >
	出生年份	<input	type=number	id=Bdy	min=0	max=255		value=""	onchange="b01_onchange(this.id,-xx, 0)">
	人物忠誠	<input	type=number	id=Loy	min=0	max=255		value=""	onchange="b01_onchange(this.id,- 9, 0)">
	人物相性	<input	type=number	id=Com	min=0	max=255		value=""	onchange="b01_onchange(this.id,-13, 0)">
	人物凶兆	<input	type=number	id=Bad	min=0	max=15		value=""	onchange="">
	</p><p>
	人物訓練	<input	type=number	id=Trn	min=0	max=255		value=""	onchange="b01_onchange(this.id,-xx, 0)">
	人物血緣	<input	type=number	id=bld	min=0	max=255		value=""	onchange="b01_onchange(this.id,-14, 0)">
	人物智力	<input	type=number	id=Int	min=0	max=255		value=""	onchange="b01_onchange(this.id,- 2, 0)">
	人物義理	<input	type=number	id=Dty	min=0	max=255		value=""	onchange="b01_onchange(this.id,- 5, 0)">
	人物狀態	<input	type=number	id=Sta	min=0	max=15		value=""	onchange="">
	</p><p>
	人物兵力	<input	type=number	id=Men	min=0	max=65535	value=""	onchange="">
	人物仕官	<input	type=number	id=Ser	min=0	max=255		value=""	onchange="b01_onchange(this.id,-10, 0)">
	人物武力	<input	type=number	id=War	min=0	max=255		value=""	onchange="b01_onchange(this.id,- 3, 0)">
	人物野望	<input	type=number	id=Abt	min=0	max=255		value=""	onchange="b01_onchange(this.id,- 6, 0)">
	人物內應	<input	type=number	id=Bty	min=0	max=15		value=""	onchange="">
	</p><p>
	人物武器	<input	type=number	id=Wpn	min=0	max=65535	value=""	onchange="">
	人物年齡	<input	type=number	id=Age	min=0	max=65535	value=""	readonly   >
	人物魅力	<input	type=number	id=Chr	min=0	max=255		value=""	onchange="b01_onchange(this.id,- 4, 0)">
	人物人德	<input	type=number	id=mor	min=0	max=255		value=""	onchange="b01_onchange(this.id,- 7, 0)">
	人物留守	<input	type=number	id=Sbt	min=0	max=15		value=""	onchange="">
	</p><p>
	未知０１	<input	type=number	id=U01	min=0	max=255		value=""	onchange="b01_onchange(this.id,-12, 0)">
	未知０２	<input	type=number	id=U02	min=0	max=255		value=""	onchange="b01_onchange(this.id,-xx, 0)">
	未知０３	<input	type=number	id=U03	min=0	max=255		value=""	onchange="b01_onchange(this.id,-xx, 0)">
	</p><p>
	匯出檔名
	<input	type=text	name=file_name	value="download.txt"	>
	</p>
	<input	type=button	name=btnConvert	value="檔案下載"					onclick="Convert()"	>
<!--
	<p>Options:</p>
	<p>	<input	type=checkbox	name="chbSeparator2"	value="sep"	checked					>remove "0x" groups from input</p>
-->
	</form>
</center>
<script type="text/javascript">
	var array;
	var point;
	function	$(x) { return document.getElementById(x); }
	function	b01_onchange(id, n1, n2){
		n1	      = n1 < 0 ? point - n1 : n1;
	var num       = $(id).value - n2;
		array     = dec.value.split(",");
		array[n1] = num;
		dec.value = array;
		array     = hex.value.split(",");
		array[n1] = '0x' + ('0' + (num).toString(16)).slice(-2);
		hex.value = array;
	}
	function	b02_onchange(id, n1, n2){
		n1	      = n1 < 0 ? point - n1 : n1;
	var num       = $(id).value;
	var val       = [(num % 256), Math.floor(num / 256)];
		array     = dec.value.split(",");
		[0,1].forEach(i => array[n1 + i] = val[i]);
		dec.value = array;
		array     = hex.value.split(",");
		[0,1].forEach(i => array[n1 + i] = '0x' + ('0' + (val[i]).toString(16)).slice(-2));
		hex.value = array;
		Age.value = G_Y.value - Bdy.value + 1 * 1;
		Age.value = Age.value < 0 ? 65535 + 1 * Age.value : Age.value;
	}
	function	oid_onchange(){
	var tmp00 = 0, tmp01 = 0;
		array = dec.value.split(",");
		point = 34 + 43 * oid.value;
	Sta.value = array[point++ * 1];
	Bad.value =             Sta.value % 16 ;				/* 人物凶兆 */
	Sta.value =  Math.floor(Sta.value / 16);				/* 人物狀態 */
	Sbt.value = array[point++ * 1];
	Bty.value =             Sbt.value % 16 ;				/* 人物內應 */
	Sbt.value =  Math.floor(Sbt.value / 16);				/* 人物留守 */
	Int.value = array[point++ * 1];							/* 人物智力 */
	War.value = array[point++ * 1];							/* 人物武力 */
	Chr.value = array[point++ * 1];							/* 人物魅力 */
	Dty.value = array[point++ * 1];							/* 人物義理 */
	mor.value = array[point++ * 1];							/* 人物人德 */
	Abt.value = array[point++ * 1];							/* 人物野望 */
	Rnk.value = array[point++ * 1];							/* 人物主管 */
	Loy.value = array[point++ * 1];							/* 人物忠誠 */
	Ser.value = array[point++ * 1];							/* 人物仕官 */
	Amb.value = array[point++ * 1];							/* 人物埋伏 */
	U01.value = array[point++ * 1];							/* 未知０１ */
	Com.value = array[point++ * 1];							/* 人物相性 */
	bld.value = array[point++ * 1];							/* 人物血緣 */
	Law.value = array[point++ * 1];							/* 人物姻親 */
		tmp00 = array[point++ * 1]; tmp01 = array[point++ * 1]; tmp00 = tmp00 * 1 + tmp01 * 256;
	Men.value = tmp00;										/* 人物兵力 */
		tmp00 = array[point++ * 1]; tmp01 = array[point++ * 1]; tmp00 = tmp00 * 1 + tmp01 * 256;
	Wpn.value = tmp00;										/* 人物武器 */
	Arm.value =  Math.floor(Wpn.value / Men.value * 100);	/* 武裝比例 */
	Trn.value = array[point++ * 1];							/* 人物訓練 */
	U02.value = array[point++ * 1];							/* 未知０２ */
	U03.value = array[point++ * 1];							/* 未知０３ */
	Bdy.value = array[point++ * 1];							/* 出生年份 */
	Age.value = G_Y.value - Bdy.value + 1 * 1;
		tmp00 = array[point++ * 1]; tmp01 = array[point++ * 1]; tmp00 = tmp00 * 1 + tmp01 * 256;
	Pic.value = tmp00;										/* 人物頭像 */
	Nam.value = "";
	Nam.value+= array[point++ * 1] + ",";					/* 人物姓名 */
	Nam.value+= array[point++ * 1] + ",";					/* 人物姓名 */
	Nam.value+= array[point++ * 1] + ",";					/* 人物姓名 */
	Nam.value+= array[point++ * 1] + ",";					/* 人物姓名 */
	Nam.value+= array[point++ * 1] + ",";					/* 人物姓名 */
	Nam.value+= array[point++ * 1];							/* 人物姓名 */
		point = 34 + 43 * oid.value;
	}
	var hD	=	"0123456789abcdef";
	function	dec2hex(d){
		var	h  = hD.substr(d&15,1);
		while(	d> 15){
			d>>=4;
			h  = hD.substr(d&15,1)+h;
		}
		return	h;
	}
	var		uint8View;
	function	Convert1(){
		var hexText = "";
		var	separator1 = "", separator2 = "";
	//	var	newline = document.frmConvert.chbNewline.checked;
	//	if(	document.frmConvert.chbSeparator1.checked){
			separator1 = "0x";
			separator2 = ",";
	//	}
		for(i=0; i<uint8View.length; i++){
			var	charVal = uint8View[i];
				hexText += separator1 + (charVal<16?"0":"") + dec2hex(charVal);
			if(	i < uint8View.length - 1)
				hexText += separator2;
		//	if (newline)
			if ((i%16) == 15) hexText += "\n";
		}
		hex.value = hexText;							/* 資料 */
			array = hexText.split(",");					/* 資料 */
		dec.value = array.map(x => Number(x));			/* 資料 */
		G_Y.value = array[12] * 1 + 256 * array[13];	/* 年份 */
		G_M.value = array[14] * 1 +   1 * 1;			/* 月份 */
		oid.value = 0;
		oid_onchange();
	}
	function	copy(id){
		var	currentFocus		= document.activeElement;
		var	target				= document.getElementById(id);
		var	origSelectionStart	= target.selectionStart;
		var	origSelectionEnd	= target.selectionEnd;
			target.focus();
			target.setSelectionRange(0, target.value.length);
		var		succeed;
		try	{	succeed = document.execCommand("copy");	}
		catch(e){	succeed = false;			}
		if(	currentFocus && typeof currentFocus.focus === "function")
			currentFocus.focus();
			target.setSelectionRange(origSelectionStart, origSelectionEnd);
	}
	function	readFileAsArray(file){
			document.frmConvert.file_name.value = file.name;
		var	reader		= new FileReader();
			reader.onload	= function(){ var arr = reader.result; uint8View = new Uint8Array(arr); Convert1(); };
			reader.readAsArrayBuffer(file);
	}
	var		openFile = function(event){ readFileAsArray(event.target.files[0]); };
	function	drop_____handler(ev){
			ev.preventDefault();
		var	dt = ev.dataTransfer;
		if(	dt.items){
		for(var i = 0; i < dt.items.length; i++){
			if(	dt.items[i].kind === "file"){
				readFileAsArray(dt.items[i].getAsFile());
				break;
			}
		}}	else	{
			for(var i = 0; i < dt.files.length; i++){
				readFileAsArray(dt.files[i]);
				break;
			}
		}
	}
	function	dragover_handler(ev){ ev.preventDefault(); }
	function	dragend__handler(ev){
		var	dt = ev.dataTransfer;
		if(	dt.items)
		for(var	i = 0; i < dt.items.length; i++)
			dt.items.remove(i);
        	else	ev.dataTransfer.clearData();
	}
	function	clean_hex(input, remove_0x){
		input	= input.toUpperCase();
		if(	remove_0x)
		input = input.replace(/0x/gi, "");
		var	orig_ = input;
		input = input.replace(/[^A-Fa-f0-9]/g, "");
//		if(	orig_!= input)
//		alert(	"Warning! Non-hex characters (including newlines) in input string ignored.");
		return	input;
	}
	function	Convert(){
		var	dec	= clean_hex(hex.value, true);
	//	var	dec	= clean_hex(hex.value, document.frmConvert.chbSeparator2.checked);
		document.frmConvert.dec.value = dec;
		if(	dec.length % 2) {
			alert(	"Error: cleaned hex string length is odd.");
			return;
		}
		var	binary		=	new	Array();
		for(var	i = 0; i<dec.length/2; i++) {
		var	h = dec.substr(i*2, 2);
			binary[i]	=	parseInt(h,16);
		}
		var	byteArray	=	new	Uint8Array(binary);
		var	a			=	window.document.createElement("a");
			a.href		=	window.URL.createObjectURL(new Blob([byteArray], { type: 'application/octet-stream' }));
			a.download	=	document.frmConvert.file_name.value;
							document.body.appendChild(a);
			a.click();		document.body.removeChild(a);
	}
</script>